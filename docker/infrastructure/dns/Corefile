# CoreDNS configuration for local domain resolution
# This file is managed by the dns-registrar service

# Local domain resolution - Internal (.danger)
danger {
    file /etc/coredns/db.danger
    log
    errors
}

# Local domain resolution - External (.danger.diy)
danger.diy {
    file /etc/coredns/db.danger.diy
    log
    errors
}

# Fallback to upstream DNS (NextDNS directly)
# Using NextDNS endpoints for secure DNS resolution with redundancy
. {
    # Primary: DNS-over-TLS with NextDNS
    forward . tls://3ca9ab.dns.nextdns.io {
        tls_servername 3ca9ab.dns.nextdns.io
        health_check 5s
        except danger danger.diy
    }

    # Fallback configuration for redundancy
    # If TLS fails, fallback to IPv6 NextDNS servers
    # Uncomment the following lines if IPv6 is available:
    # forward . 2a07:a8c0::3c:a9ab 2a07:a8c1::3c:a9ab {
    #     except danger danger.diy
    # }

    log
    errors
    cache 300  # 5 minutes cache for better performance
    reload

    # Enable DNSSEC validation
    dnssec
}
