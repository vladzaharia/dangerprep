#!/bin/sh
# DangerPrep Portable Gum Wrapper
# Prefers system-installed gum, falls back to platform-specific binary

# Check if gum is available in PATH first
if command -v gum >/dev/null 2>&1; then
    # Use system-installed gum
    exec gum "$@"
fi

# Fall back to bundled binary
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Platform detection
detect_platform() {
    case "$(uname -s)" in
        Linux*)     os="linux" ;;
        Darwin*)    os="darwin" ;;
        CYGWIN*|MINGW*|MSYS*) os="windows" ;;
        *)          echo "Unsupported operating system: $(uname -s)" >&2; exit 1 ;;
    esac

    case "$(uname -m)" in
        x86_64|amd64)   arch="x86_64" ;;
        aarch64|arm64)  arch="aarch64" ;;
        armv7l)         arch="armv7" ;;
        arm*)           arch="arm" ;;
        *)              echo "Unsupported architecture: $(uname -m)" >&2; exit 1 ;;
    esac

    echo "${os}-${arch}"
}

# Get platform-specific binary name
PLATFORM=$(detect_platform)
GUM_BINARY="$SCRIPT_DIR/gum-$PLATFORM"

# Check if binary exists
if [ ! -f "$GUM_BINARY" ]; then
    echo "Gum binary for platform $PLATFORM not found: $GUM_BINARY" >&2
    echo "Run '$SCRIPT_DIR/download.sh' to download platform-specific binaries" >&2
    echo "Or install gum system-wide: https://github.com/charmbracelet/gum#installation" >&2
    exit 1
fi

# Check if binary is executable
if [ ! -x "$GUM_BINARY" ]; then
    echo "Gum binary is not executable: $GUM_BINARY" >&2
    echo "Run 'chmod +x $GUM_BINARY' to fix permissions" >&2
    exit 1
fi

# Execute the platform-specific gum binary with all arguments
exec "$GUM_BINARY" "$@"
